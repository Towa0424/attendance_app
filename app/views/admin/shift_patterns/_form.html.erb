<section class="card">
  <div class="card__body">
    <% if time_blocks.empty? %>
      <div class="alert alert--error">
        先に「時間ブロック管理」で時間ブロックを作成してください。
      </div>
    <% end %>

    <% if shift_pattern.errors.any? %>
      <div class="alert alert--error">
        <div style="font-weight:700; margin-bottom:6px;">入力内容を確認してください</div>
        <ul style="margin:0; padding-left: 18px;">
          <% shift_pattern.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <%= form_with model: [:admin, shift_pattern], local: true, class: "form" do |f| %>
      <div class="grid2">
        <div class="form__row">
          <%= f.label :name, "シフトパターン名", class: "label" %>
          <%= f.text_field :name, class: "input", placeholder: "例：早番（平日）" %>
        </div>

        <div class="form__row">
          <%= f.label :group_id, "所属グループ", class: "label" %>
          <%= f.collection_select :group_id, groups, :id, :name,
                { include_blank: "選択してください" },
                { class: "select", id: "spGroupSelect" } %>
        </div>
      </div>

      <div class="spLegend">
        <div class="spLegend__blocks">
          <% time_blocks.each do |tb| %>
            <button type="button"
                    class="spLegend__item"
                    data-time-block-id="<%= tb.id %>"
                    data-time-block-color="<%= tb.color_code %>">
              <span class="spDot" style="--c:<%= tb.color_code %>"></span>
              <%= tb.name %>
            </button>
          <% end %>
        </div>

        <div class="spLegend__tools">
          <button type="button" class="spToolBtn" id="spEraserBtn" aria-label="消しゴム（押している間だけ有効）">
            <span class="spToolBtn__icon">⌫</span>
            消しゴム
          </button>

          <button type="button" class="spToolBtn" id="spResetBtn" aria-label="ガントのみリセット">
            <span class="spToolBtn__icon">↺</span>
            ガントリセット
          </button>
        </div>
      </div>

      <div class="spWrap"
           data-sp-editor="1"
           data-group-ranges="<%= group_ranges.to_json %>"
           data-initial-slots="<%= slots.to_json %>">
        <div class="spFrame">
          <div class="spHours">
            <div class="spHours__row" id="spHoursRow"></div>
            <div class="spHours__end" id="spHoursEnd"></div>
          </div>

          <div class="spLane is-disabled" id="spLane" aria-label="シフトパターンの時間帯">
            <div class="spHover" id="spHover"></div>
          </div>
        </div>
      </div>

      <%= hidden_field_tag "shift_pattern[slots_json]", slots.to_json, id: "spSlotsJson" %>

      <div style="display:flex; justify-content:flex-end;">
        <%= f.submit(shift_pattern.persisted? ? "更新する" : "作成する", class: "btn btn--primary") %>
      </div>
    <% end %>
  </div>
</section>

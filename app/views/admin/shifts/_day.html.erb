<% return if @group.nil? %>

<div class="shiftDayHead">
  <div class="shiftDayHead__left">
    <span class="tag"><%= @date.strftime("%Y/%m/%d") %></span>
    <span class="muted" style="font-size:12px; margin-left:8px;">
      表示時間：<%= ShiftPattern.slot_to_hhmm(@range_start) %> 〜 <%= ShiftPattern.slot_to_hhmm(@range_end) %>
    </span>
  </div>

  <div class="shiftDayHead__nav">
    <%= link_to "前日",
          admin_shifts_path(group_id: @group_id, view: "day", date: (@date - 1).iso8601),
          class: "btn btn--ghost btn--sm" %>

    <%= link_to "今日",
          admin_shifts_path(group_id: @group_id, view: "day", date: Date.current.iso8601),
          class: "btn btn--ghost btn--sm" %>

    <%= link_to "翌日",
          admin_shifts_path(group_id: @group_id, view: "day", date: (@date + 1).iso8601),
          class: "btn btn--ghost btn--sm" %>
  </div>
</div>

<div class="shiftDayTools">
  <% if @time_blocks.present? %>
    <div class="spLegend" data-shift-day-legend="1">
      <% @time_blocks.each do |tb| %>
        <button
          type="button"
          class="spLegend__item"
          data-time-block-id="<%= tb.id %>"
          data-time-block-color="<%= tb.color_code %>">
          <span class="spLegend__dot" style="--c:<%= tb.color_code %>"></span>
          <span><%= tb.name %></span>
        </button>
      <% end %>
    </div>
  <% else %>
    <div class="muted">時間ブロックがありません。</div>
  <% end %>

  <div class="spTools">
    <button type="button" class="btn btn--ghost btn--sm" data-shift-day-eraser="1">修正</button>
  </div>
</div>

<div class="shiftDayGrid"
     data-shift-day-editor="1"
     data-assign-url="<%= assign_admin_shifts_path %>"
     data-update-url="<%= update_details_admin_shifts_path %>"
     data-range-start="<%= @range_start %>"
     data-range-end="<%= @range_end %>"
     style="--slot-w:18px; --slots:<%= (@range_end - @range_start) %>;">
  <div class="shiftDayGrid__nameCol">
    <div class="shiftDayGrid__nameHead">氏名</div>
    <% @users.each do |u| %>
      <div class="shiftDayGrid__nameCell">
        <div class="shiftUserCell">
          <div class="shiftUserCell__name"><%= u.name %></div>
          <div class="shiftUserCell__sub muted"><%= u.employee_number %></div>
        </div>
      </div>
    <% end %>
  </div>

  <div class="shiftDayGrid__patternCol">
    <div class="shiftDayGrid__patternHead">パターン</div>
    <% @users.each do |u| %>
      <% shift = @shifts_by_user[u.id] %>
      <div class="shiftDayGrid__patternCell">
        <select
          class="select select--sm shiftDayPatternSelect"
          data-shift-day-pattern-select="1"
          data-user-id="<%= u.id %>"
          data-work-date="<%= @date.iso8601 %>">
          <option value="">未設定</option>
          <% @shift_patterns.each do |sp| %>
            <option value="<%= sp.id %>" <%= "selected" if shift&.shift_pattern_id == sp.id %>>
              <%= sp.name %>
            </option>
          <% end %>
        </select>
      </div>
    <% end %>
  </div>

  <div class="shiftDayGrid__ganttCol">
    <!-- 横スクロールはここだけ -->
    <div class="shiftDayScroll">
      <div class="shiftDayCanvas">
        <!-- Hours -->
        <div class="shiftDayHours">
          <div class="shiftDayHoursRow">
            <% ((@range_start / 4)...(@range_end / 4)).each do |h| %>
              <div class="shiftDayHourCell"><%= format("%02d:00", h) %></div>
            <% end %>
          </div>

          <% unless @end_on_hour %>
            <div class="shiftDayHoursEnd"><%= ShiftPattern.slot_to_hhmm(@range_end) %></div>
          <% end %>
        </div>

        <!-- Lanes -->
        <% @users.each do |u| %>
          <% shift = @shifts_by_user[u.id] %>
          <% slots = shift.present? ? shift.slots_array : Array.new(ShiftPattern::SLOTS_PER_DAY, nil) %>
          <% blocks = ShiftPattern.blocks_from_slots(slots, range_start: @range_start, range_end: @range_end) %>

          <div class="shiftDayLane <%= 'is-disabled' if shift.blank? %>"
               data-shift-day-lane="1"
               data-user-id="<%= u.id %>"
               data-work-date="<%= @date.iso8601 %>"
               data-slots="<%= json_escape(slots.to_json) %>">
            <% blocks.each do |b| %>
              <% tb = @time_block_map[b[:time_block_id]] %>
              <% next if tb.nil? %>

              <div class="shiftDayBlock"
                   style="--start:<%= (b[:start] - @range_start) %>; --end:<%= (b[:end] - @range_start) %>; --c:<%= tb.color_code %>;"
                   title="<%= tb.name %>"></div>
            <% end %>

          </div>
        <% end %>

        <% if @users.empty? %>
          <div class="muted ta-c" style="padding:14px;">このグループにスタッフがいません。</div>
        <% end %>
      </div>
    </div>
  </div>
</div>
